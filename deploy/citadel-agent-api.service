[Unit]
Description=Citadel Agent API Service
After=network.target
After=postgresql.service
After=redis.service
Wants=postgresql.service redis.service

[Service]
Type=simple
User=citadel
Group=citadel
WorkingDirectory=/opt/citadel-agent/backend
ExecStart=/opt/citadel-agent/bin/api
Restart=always
RestartSec=10

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/citadel-agent/storage
ReadWritePaths=/opt/citadel-agent/logs

# Environment variables
Environment=ENVIRONMENT=production
Environment=SERVER_PORT=5001
Environment=JWT_SECRET_FILE=/etc/citadel-agent/secrets/jwt-secret
Environment=GITHUB_CLIENT_ID_FILE=/etc/citadel-agent/secrets/github-client-id
Environment=GITHUB_CLIENT_SECRET_FILE=/etc/citadel-agent/secrets/github-client-secret
Environment=GOOGLE_CLIENT_ID_FILE=/etc/citadel-agent/secrets/google-client-id
Environment=GOOGLE_CLIENT_SECRET_FILE=/etc/citadel-agent/secrets/google-client-secret

# Networking
AmbientCapabilities=CAP_NET_BIND_SERVICE
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target